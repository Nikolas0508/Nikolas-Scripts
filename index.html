<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  addDoc, 
  getDocs, 
  deleteDoc, 
  doc 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

try {

const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "SEU_AUTH_DOMAIN",
  projectId: "SEU_PROJECT_ID",
  storageBucket: "SEU_BUCKET",
  messagingSenderId: "SEU_ID",
  appId: "SEU_APP_ID"
};

const appFirebase = initializeApp(firebaseConfig);
const db = getFirestore(appFirebase);

let currentUser = null;
let isAdmin = false;

window.login = async function() {
  try {

    const u = document.getElementById("username").value;
    const p = document.getElementById("password").value;

    if(u === "NikolasP" && p === "2011"){
      isAdmin = true;
      start(u);
      return;
    }

    const snapshot = await getDocs(collection(db, "users"));
    let found = false;

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      if(data.username === u && data.password === p){
        found = true;
      }
    });

    if(!found){
      document.getElementById("msg").innerText = "Usuário inválido";
      return;
    }

    start(u);

  } catch(err){
    console.error("Erro no login:", err);
  }
};

function start(user){
  currentUser = user;

  document.getElementById("loginPage").style.display = "none";
  document.getElementById("app").style.display = "block";
  document.getElementById("userDisplay").innerText = user;

  if(isAdmin){
    document.getElementById("adminBtn").classList.remove("hidden");
    document.getElementById("addScriptBox").classList.remove("hidden");
    loadUsers();
  }

  loadScripts();
}

window.show = function(id){
  ["inicio","scripts","admin"].forEach(x=>{
    document.getElementById(x).classList.add("hidden");
  });
  document.getElementById(id).classList.remove("hidden");
};

async function loadScripts(){
  const list = document.getElementById("scriptList");
  list.innerHTML = "";

  const snapshot = await getDocs(collection(db,"scripts"));

  snapshot.forEach(docSnap=>{
    const data = docSnap.data();

    const div = document.createElement("div");
    div.className="card";
    div.innerHTML = `
      <b>${data.name}</b><br><br>
      <button onclick="copyText(\`${data.content}\`)">Copiar</button>
      ${isAdmin ? `<button onclick="deleteScript('${docSnap.id}')">Excluir</button>` : ""}
    `;
    list.appendChild(div);
  });
}

window.copyText = function(text){
  navigator.clipboard.writeText(text);
  alert("Copiado!");
};

window.addScript = async function(){
  await addDoc(collection(db,"scripts"),{
    name: document.getElementById("scriptName").value,
    content: document.getElementById("scriptContent").value
  });

  loadScripts();
};

async function loadUsers(){
  const container = document.getElementById("usersContainer");
  container.innerHTML = "";

  const snapshot = await getDocs(collection(db,"users"));

  snapshot.forEach(docSnap=>{
    const data = docSnap.data();

    const div = document.createElement("div");
    div.className="card";
    div.innerHTML = `
      <b>${data.username}</b>
      <button onclick="deleteUser('${docSnap.id}')">Remover</button>
    `;
    container.appendChild(div);
  });
}

window.addUser = async function(){
  await addDoc(collection(db,"users"),{
    username: document.getElementById("newUser").value,
    password: document.getElementById("newPass").value
  });

  loadUsers();
};

window.deleteUser = async function(id){
  await deleteDoc(doc(db,"users",id));
  loadUsers();
};

} catch(e){
  console.error("Erro geral:", e);
}
</script>
